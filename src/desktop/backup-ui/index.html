<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>TKO Loyalty</title>
    <style>
      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          Helvetica, Arial, sans-serif;
        margin: 0;
        padding: 0;
        background-color: #f5f5f5;
        color: #333;
      }

      /* Main window styles */
      .main-container {
        display: none;
        padding: 20px;
        max-width: 1200px;
        margin: 0 auto;
      }

      /* Popup window styles */
      .popup-container {
        display: none;
        padding: 15px;
        background-color: #fff;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        width: 100%;
        max-width: 400px;
        margin: 0 auto;
      }

      .header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        padding-bottom: 10px;
        border-bottom: 1px solid #eee;
      }

      .header h1 {
        margin: 0;
        font-size: 24px;
        color: #2c3e50;
      }

      .search-container {
        margin-bottom: 20px;
      }

      .search-input {
        width: 100%;
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 16px;
        box-sizing: border-box;
      }

      .customer-card {
        background-color: #fff;
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 15px;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
      }

      .customer-name {
        font-size: 18px;
        font-weight: bold;
        margin: 0 0 5px 0;
      }

      .customer-info {
        font-size: 14px;
        color: #666;
        margin: 5px 0;
      }

      .tier-badge {
        display: inline-block;
        padding: 3px 8px;
        border-radius: 12px;
        font-size: 12px;
        font-weight: bold;
        margin-left: 5px;
      }

      .tier-bronze {
        background-color: #cd7f32;
        color: white;
      }

      .tier-silver {
        background-color: #c0c0c0;
        color: white;
      }

      .tier-gold {
        background-color: #ffd700;
        color: #333;
      }

      .tier-platinum {
        background-color: #e5e4e2;
        color: #333;
      }

      .button {
        padding: 8px 16px;
        background-color: #3498db;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 14px;
        transition: background-color 0.2s;
      }

      .button:hover {
        background-color: #2980b9;
      }

      .button-secondary {
        background-color: #95a5a6;
      }

      .button-secondary:hover {
        background-color: #7f8c8d;
      }

      .close-button {
        background: none;
        border: none;
        font-size: 20px;
        cursor: pointer;
        color: #95a5a6;
      }

      .close-button:hover {
        color: #7f8c8d;
      }

      .loading {
        text-align: center;
        padding: 20px;
        color: #7f8c8d;
      }

      .error {
        color: #e74c3c;
        padding: 10px;
        background-color: #fadbd8;
        border-radius: 4px;
        margin-bottom: 15px;
      }

      .tabs {
        display: flex;
        margin-bottom: 20px;
        border-bottom: 1px solid #ddd;
      }

      .tab {
        padding: 10px 20px;
        cursor: pointer;
        border-bottom: 2px solid transparent;
      }

      .tab.active {
        border-bottom: 2px solid #3498db;
        color: #3498db;
      }

      .tab-content {
        display: none;
      }

      .tab-content.active {
        display: block;
      }

      .progress-bar-container {
        width: 100%;
        height: 10px;
        background-color: #ecf0f1;
        border-radius: 5px;
        margin: 10px 0;
      }

      .progress-bar {
        height: 100%;
        border-radius: 5px;
        background-color: #3498db;
      }
    </style>
  </head>
  <body>
    <!-- Main Window Container -->
    <div id="main-container" class="main-container">
      <div class="header">
        <h1>TKO Loyalty Dashboard</h1>
        <div>
          <button id="refresh-button" class="button">Refresh Data</button>
          <button id="settings-button" class="button button-secondary">
            Settings
          </button>
        </div>
      </div>

      <div class="tabs">
        <div class="tab active" data-tab="customers">Customers</div>
        <div class="tab" data-tab="tiers">Tiers</div>
        <div class="tab" data-tab="reports">Reports</div>
      </div>

      <div id="customers-tab" class="tab-content active">
        <div class="search-container">
          <input
            type="text"
            id="customer-search"
            class="search-input"
            placeholder="Search customers by name, email, or phone..."
          />
        </div>
        <div id="customers-list">
          <div class="loading">Loading customers...</div>
        </div>
      </div>

      <div id="tiers-tab" class="tab-content">
        <h2>Loyalty Tiers</h2>
        <div id="tiers-list">
          <div class="loading">Loading tiers...</div>
        </div>
      </div>

      <div id="reports-tab" class="tab-content">
        <h2>Reports</h2>
        <div id="reports-content">
          <div class="loading">Loading reports...</div>
        </div>
      </div>
    </div>

    <!-- Popup Window Container -->
    <div id="popup-container" class="popup-container">
      <div class="header">
        <h1>Customer Lookup</h1>
        <button id="close-popup" class="close-button">&times;</button>
      </div>

      <div class="search-container">
        <input
          type="text"
          id="popup-search"
          class="search-input"
          placeholder="Enter phone number or name..."
        />
      </div>

      <div id="customer-result">
        <!-- Customer data will be displayed here -->
      </div>
    </div>

    <script>
      // Determine which view to show based on URL parameter
      document.addEventListener("DOMContentLoaded", () => {
        const urlParams = new URLSearchParams(window.location.search);
        const view = urlParams.get("view");

        if (view === "main") {
          document.getElementById("main-container").style.display = "block";
          initializeMainView();
        } else if (view === "popup") {
          document.getElementById("popup-container").style.display = "block";
          initializePopupView();
        }
      });

      // Main window initialization
      function initializeMainView() {
        // Tab switching
        document.querySelectorAll(".tab").forEach((tab) => {
          tab.addEventListener("click", () => {
            // Remove active class from all tabs and content
            document
              .querySelectorAll(".tab")
              .forEach((t) => t.classList.remove("active"));
            document
              .querySelectorAll(".tab-content")
              .forEach((c) => c.classList.remove("active"));

            // Add active class to clicked tab and corresponding content
            tab.classList.add("active");
            const tabName = tab.getAttribute("data-tab");
            document.getElementById(`${tabName}-tab`).classList.add("active");
          });
        });

        // Refresh button
        document
          .getElementById("refresh-button")
          .addEventListener("click", () => {
            document.getElementById("customers-list").innerHTML =
              '<div class="loading">Refreshing data...</div>';
            window.electronAPI.syncData();
          });

        // Settings button
        document
          .getElementById("settings-button")
          .addEventListener("click", () => {
            // TODO: Implement settings dialog
            alert("Settings dialog not yet implemented");
          });

        // Customer search
        document
          .getElementById("customer-search")
          .addEventListener("input", (e) => {
            const searchTerm = e.target.value.trim();
            if (searchTerm.length >= 3) {
              searchCustomers(searchTerm);
            } else if (searchTerm.length === 0) {
              loadAllCustomers();
            }
          });

        // Initial data load
        loadAllCustomers();
      }

      // Popup window initialization
      function initializePopupView() {
        // Close button
        document.getElementById("close-popup").addEventListener("click", () => {
          window.electronAPI.hidePopupWindow();
        });

        // Search input
        document
          .getElementById("popup-search")
          .addEventListener("keypress", (e) => {
            if (e.key === "Enter") {
              const searchTerm = e.target.value.trim();
              if (searchTerm) {
                lookupCustomer(searchTerm);
              }
            }
          });

        // Listen for customer data from main process
        window.electronAPI.onCustomerData((customer) => {
          displayCustomerInPopup(customer);
        });
      }

      // Load all customers
      function loadAllCustomers() {
        document.getElementById("customers-list").innerHTML =
          '<div class="loading">Loading customers...</div>';

        window.electronAPI
          .getShopifyCustomers()
          .then((result) => {
            if (
              result.success &&
              result.customers &&
              result.customers.length > 0
            ) {
              displayCustomers(result.customers);
            } else {
              document.getElementById("customers-list").innerHTML =
                '<div class="error">No customers found</div>';
            }
          })
          .catch((error) => {
            document.getElementById(
              "customers-list"
            ).innerHTML = `<div class="error">Error loading customers: ${error.message}</div>`;
          });
      }

      // Search customers
      function searchCustomers(query) {
        document.getElementById("customers-list").innerHTML =
          '<div class="loading">Searching...</div>';

        window.electronAPI
          .searchCustomers(query)
          .then((result) => {
            if (
              result.success &&
              result.customers &&
              result.customers.length > 0
            ) {
              displayCustomers(result.customers);
            } else {
              document.getElementById("customers-list").innerHTML =
                '<div class="error">No customers found</div>';
            }
          })
          .catch((error) => {
            document.getElementById(
              "customers-list"
            ).innerHTML = `<div class="error">Error searching customers: ${error.message}</div>`;
          });
      }

      // Display customers in the main window
      function displayCustomers(customers) {
        const customersList = document.getElementById("customers-list");
        customersList.innerHTML = "";

        customers.forEach((customer) => {
          const tierClass = customer.currentTier
            ? `tier-${customer.currentTier.name.toLowerCase()}`
            : "";
          const tierName = customer.currentTier
            ? customer.currentTier.name
            : "No Tier";

          const customerCard = document.createElement("div");
          customerCard.className = "customer-card";
          customerCard.innerHTML = `
          <h3 class="customer-name">${
            customer.name
          } <span class="tier-badge ${tierClass}">${tierName}</span></h3>
          <p class="customer-info">${customer.email || "No email"} | ${
            customer.phone || "No phone"
          }</p>
          <p class="customer-info">Total Spend: $${customer.totalSpend.toFixed(
            2
          )}</p>
          <button class="button view-customer" data-id="${
            customer.id
          }">View Details</button>
        `;

          customersList.appendChild(customerCard);

          // Add event listener to view button
          customerCard
            .querySelector(".view-customer")
            .addEventListener("click", () => {
              viewCustomerDetails(customer.id);
            });
        });
      }

      // Lookup customer in popup
      function lookupCustomer(query) {
        document.getElementById("customer-result").innerHTML =
          '<div class="loading">Looking up customer...</div>';

        window.electronAPI.lookupCustomer(query);
      }

      // Display customer in popup
      function displayCustomerInPopup(customer) {
        const customerResult = document.getElementById("customer-result");

        if (!customer || !customer.name) {
          customerResult.innerHTML =
            '<div class="error">Customer not found</div>';
          return;
        }

        const tierClass = customer.currentTier
          ? `tier-${customer.currentTier.name.toLowerCase()}`
          : "";
        const tierName = customer.currentTier
          ? customer.currentTier.name
          : "No Tier";

        customerResult.innerHTML = `
        <div class="customer-card">
          <h3 class="customer-name">${
            customer.name
          } <span class="tier-badge ${tierClass}">${tierName}</span></h3>
          <p class="customer-info">${customer.email || "No email"}</p>
          <p class="customer-info">${customer.phone || "No phone"}</p>
          <p class="customer-info">Total Spend: $${
            customer.totalSpend ? customer.totalSpend.toFixed(2) : "0.00"
          }</p>
          <button id="view-in-main" class="button">View in Dashboard</button>
        </div>
      `;

        // Add event listener to view in main button
        document
          .getElementById("view-in-main")
          .addEventListener("click", () => {
            window.electronAPI.openCustomerInMain(customer.id);
          });
      }

      // View customer details
      function viewCustomerDetails(customerId) {
        // TODO: Implement customer details view
        alert(`View customer details for ID: ${customerId}`);
      }
    </script>
    <!-- Root element for React -->
    <div id="root"></div>

    <!-- Include the compiled JavaScript -->
    <script src="./index.js"></script>
  </body>
</html>
